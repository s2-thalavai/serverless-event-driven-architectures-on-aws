# Enrich event data using an Amazon EventBridge Pipe.

## Technical Task Description

This exercise demonstrates how to use an Amazon EventBridge Pipe to filter and enrich events in transit. 
The Pipe reads messages from an SQS queue, enriches them through a Lambda function that queries a DynamoDB table, 
and publishes the enhanced data to an SNS topic.

## High-Level Architecture Overview

<img width="1387" height="848" alt="image" src="https://github.com/user-attachments/assets/ad3e3d85-90a8-4eb6-ab6a-5dbbf9dc9c7f" />

## Core AWS Components Used

| Component             | Purpose                                                         |
| --------------------- | --------------------------------------------------------------- |
| **Amazon SQS**        | Decouple message producers from consumers. Source for the Pipe. |
| **EventBridge Pipes** | Connects source to target; adds filtering and enrichment.       |
| **AWS Lambda**        | Enriches messages with extra data from DynamoDB.                |
| **Amazon DynamoDB**   | Stores enrichment data (e.g., lookup information).              |
| **Amazon SNS**        | Publishes final messages to subscribers (email, etc.).          |

## Overview of the Pipe Flow

### 1. SQS Queue (Source)

- The SQS queue will receive messages (for example, from an application or another AWS service).

- This will act as the EventBridge Pipe source.

### 2. EventBridge Pipe

- The Pipe connects the SQS queue (source) to the Lambda function (target).

- It applies filters to only process relevant messages.

- It also supports enrichment, which youâ€™ll perform using the Lambda function.

### 3. Lambda Function (Enricher)

- The Lambda function will be invoked by the Pipe when a filtered message arrives.

- It will fetch additional data from DynamoDB to enrich the message.

- The enriched message will then be published to the SNS topic.

### 4. DynamoDB Table

- Stores data that the Lambda function uses to enrich incoming messages (e.g., user info, product details, etc.).

### 5. SNS Topic (Destination)

- Receives the enriched message from the Lambda function.

- Publishes the message to subscribers, such as an email endpoint.

### 6. Email Subscriber

- Youâ€™ll subscribe an email address to the SNS topic to receive the final, enriched event notifications.

---


## 1. Purpose:

- The Pipe source listens to the SQS queue.

- The Pipe enrichment step invokes a Lambda function to add extra data.

- The Pipe target sends the enriched event to an SNS topic.


## 2. Prerequisites

- Make sure the IAM Role for the Pipe has permissions to:

  - Read from SQS
                
  - Invoke the Lambda function
        
  - Publish to SNS
        
  - Read/write from EventBridge Pipes

### Example minimal IAM policy (attach to the Pipe execution role):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:sqs:REGION:ACCOUNT_ID:MySourceQueue"
    },
    {
      "Action": "lambda:InvokeFunction",
      "Effect": "Allow",
      "Resource": "arn:aws:lambda:REGION:ACCOUNT_ID:function:EnrichLambda"
    },
    {
      "Action": "sns:Publish",
      "Effect": "Allow",
      "Resource": "arn:aws:sns:REGION:ACCOUNT_ID:MyTargetTopic"
    }
  ]
}

```

### 3. Creating the Pipe via AWS Console

1. Open Amazon EventBridge â†’ Pipes â†’ Create pipe

2. Pipe name: SQSLambdaSNSTestPipe

3. Source: Select your SQS queue

4. Filter (optional):

    ```json
    {
      "detail-type": ["order-created"]
    }
    ```

5. Enrichment: Choose Lambda function â†’ EnrichLambda

6. Target: Select SNS topic â†’ MyTargetTopic

7. Permissions:

    - Create or choose an existing IAM role with permissions above.

8. Click Create pipe

Once the Pipe is active, EventBridge automatically reads messages from SQS, invokes your Lambda to enrich them, and sends the output to SNS.

## 4. Creating the Pipe Using AWS CLI

Hereâ€™s how to do the same from the CLI:

```bash
aws pipes create-pipe \
  --name SQSLambdaSNSTestPipe \
  --source arn:aws:sqs:REGION:ACCOUNT_ID:MySourceQueue \
  --enrichment arn:aws:lambda:REGION:ACCOUNT_ID:function:EnrichLambda \
  --target arn:aws:sns:REGION:ACCOUNT_ID:MyTargetTopic \
  --role-arn arn:aws:iam::ACCOUNT_ID:role/EventBridgePipeRole \
  --source-parameters '{"SqsQueueParameters": {"BatchSize": 1}}' \
  --enrichment-parameters '{"InputTemplate": "{\"message\": <$.body> }"}'
```

ðŸ’¡ You can add filters and advanced enrichment templates using --filter-criteria and --enrichment-parameters.

### Example filter:

```bash
--filter-criteria '{
  "Filters": [
    {
      "Pattern": "{\"detail-type\": [\"order-created\"]}"
    }
  ]
}'
```

## 5. Testing the Flow

- Send a test message to SQS:

```bash
aws sqs send-message \
  --queue-url https://sqs.REGION.amazonaws.com/ACCOUNT_ID/MySourceQueue \
  --message-body '{"detail-type": "order-created", "orderId": "12345"}'
```

- Watch the Lambda logs in CloudWatch â€” you should see it invoked by EventBridge Pipe.

- Check the SNS email (if you subscribed via email) â€” you should receive the enriched event.

## 6. Verification Checklist

| Component          | Status | Checkpoint                |
| ------------------ | ------ | ------------------------- |
| SQS Queue          | âœ…      | Message sent              |
| EventBridge Pipe   | âœ…      | Active & connected        |
| Lambda Function    | âœ…      | Invoked for enrichment    |
| DynamoDB (if used) | âœ…      | Queried successfully      |
| SNS Topic          | âœ…      | Message received          |
| Email Subscriber   | âœ…      | Enriched message received |

---

## What This Lambda Does

- Reads messages from SQS (via EventBridge Pipe).

- Queries DynamoDB for matching records (based on CustomerId).

- Merges enrichment data with the original message.

- Publishes the enriched message to SNS, which then triggers an email or other subscriber.

## 1. Lambda Function(python): Enrich and Forward

```python
import json
import boto3
from boto3.dynamodb.conditions import Key

# Initialize AWS clients
dynamodb = boto3.resource('dynamodb')
sns = boto3.client('sns')

# Environment variables (set in Lambda configuration)
DYNAMODB_TABLE = 'CustomerData'
SNS_TOPIC_ARN = 'arn:aws:sns:REGION:ACCOUNT_ID:MyTargetTopic'

def lambda_handler(event, context):
    """
    Lambda function to enrich incoming event data with customer info from DynamoDB,
    and publish the enriched message to SNS.
    """

    table = dynamodb.Table(DYNAMODB_TABLE)

    enriched_events = []

    for record in event.get('Records', []):
        # The SQS message body (string)
        body = json.loads(record['body'])

        # Extract CustomerId or other identifying field
        customer_id = body.get('CustomerId')

        # Fetch additional info from DynamoDB
        enrichment_data = {}
        if customer_id:
            response = table.query(
                KeyConditionExpression=Key('CustomerId').eq(customer_id)
            )
            items = response.get('Items', [])
            if items:
                enrichment_data = items[0]

        # Combine the original message with enrichment data
        enriched_message = {
            'OriginalEvent': body,
            'EnrichedData': enrichment_data
        }

        # Publish the enriched message to SNS
        sns.publish(
            TopicArn=SNS_TOPIC_ARN,
            Message=json.dumps(enriched_message, default=str),
            Subject=f'Enriched Event for Customer {customer_id}'
        )

        enriched_events.append(enriched_message)

    return {
        'statusCode': 200,
        'body': json.dumps({
            'message': 'Events enriched and published successfully',
            'count': len(enriched_events)
        })
    }
```

### Environment Variables (set in Lambda console)

| Variable         | Description          | Example                                            |
| ---------------- | -------------------- | -------------------------------------------------- |
| `DYNAMODB_TABLE` | DynamoDB table name  | `CustomerData`                                     |
| `SNS_TOPIC_ARN`  | Target SNS topic ARN | `arn:aws:sns:us-east-1:123456789012:MyTargetTopic` |

### Testing

You can test this Lambda manually in the console with a sample SQS-like event:

```json
{
  "Records": [
    {
      "body": "{\"CustomerId\": \"CUST1001\", \"orderId\": \"ORD9001\", \"detail-type\": \"order-created\"}"
    }
  ]
}
```

### How It Works

- Receives input from EventBridge Pipe (SQS message).

- Parses the message to extract CustomerId.

- Queries DynamoDB for matching customer data.

- Combines original and enriched data into a single JSON object.

- Publishes the enriched message to your SNS topic.

---

## 2. Lambda Function (JavaScript â€“ Node.js 18+): Enrich and Forward

```javascript
import { DynamoDBClient, QueryCommand } from "@aws-sdk/client-dynamodb";
import { SNSClient, PublishCommand } from "@aws-sdk/client-sns";

const dynamodb = new DynamoDBClient({ region: process.env.AWS_REGION });
const sns = new SNSClient({ region: process.env.AWS_REGION });

// Environment variables (configure these in Lambda)
const DYNAMODB_TABLE = process.env.DYNAMODB_TABLE || "CustomerData";
const SNS_TOPIC_ARN = process.env.SNS_TOPIC_ARN;

export const handler = async (event) => {
  const enrichedEvents = [];

  for (const record of event.Records || []) {
    try {
      // Parse incoming SQS message
      const body = JSON.parse(record.body);
      const customerId = body.CustomerId;

      let enrichmentData = {};

      if (customerId) {
        // Fetch enrichment data from DynamoDB
        const command = new QueryCommand({
          TableName: DYNAMODB_TABLE,
          KeyConditionExpression: "CustomerId = :id",
          ExpressionAttributeValues: {
            ":id": { S: customerId },
          },
        });

        const response = await dynamodb.send(command);
        if (response.Items && response.Items.length > 0) {
          enrichmentData = response.Items[0];
        }
      }

      // Combine original message + enrichment data
      const enrichedMessage = {
        OriginalEvent: body,
        EnrichedData: enrichmentData,
      };

      // Publish to SNS
      const publishCommand = new PublishCommand({
        TopicArn: SNS_TOPIC_ARN,
        Message: JSON.stringify(enrichedMessage),
        Subject: `Enriched Event for Customer ${customerId}`,
      });

      await sns.send(publishCommand);
      enrichedEvents.push(enrichedMessage);

    } catch (err) {
      console.error("Error processing record:", err);
    }
  }

  return {
    statusCode: 200,
    body: JSON.stringify({
      message: "Events enriched and published successfully",
      count: enrichedEvents.length,
    }),
  };
};
```

### Environment Variables (set in Lambda console)

Set these in the Lambda Configuration â†’ Environment Variables section:

| Variable         | Description          | Example                                            |
| ---------------- | -------------------- | -------------------------------------------------- |
| `DYNAMODB_TABLE` | DynamoDB table name  | `CustomerData`                                     |
| `SNS_TOPIC_ARN`  | Target SNS topic ARN | `arn:aws:sns:us-east-1:123456789012:MyTargetTopic` |

### Test Event (Sample Input)

Use this in the Lambda Test tab to simulate an SQS-triggered event:

```json
{
  "Records": [
    {
      "body": "{\"CustomerId\": \"CUST1001\", \"orderId\": \"ORD9001\", \"detail-type\": \"order-created\"}"
    }
  ]
}
```
