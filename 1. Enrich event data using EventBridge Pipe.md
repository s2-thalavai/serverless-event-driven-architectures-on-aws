# Enrich event data using an Amazon EventBridge Pipe.

## Technical Task Description

This exercise demonstrates how to use an Amazon EventBridge Pipe to filter and enrich events in transit. 
The Pipe reads messages from an SQS queue, enriches them through a Lambda function that queries a DynamoDB table, 
and publishes the enhanced data to an SNS topic.

## High-Level Architecture Overview

<img width="1387" height="848" alt="image" src="https://github.com/user-attachments/assets/ad3e3d85-90a8-4eb6-ab6a-5dbbf9dc9c7f" />

## Core AWS Components Used

| Component             | Purpose                                                         |
| --------------------- | --------------------------------------------------------------- |
| **Amazon SQS**        | Decouple message producers from consumers. Source for the Pipe. |
| **EventBridge Pipes** | Connects source to target; adds filtering and enrichment.       |
| **AWS Lambda**        | Enriches messages with extra data from DynamoDB.                |
| **Amazon DynamoDB**   | Stores enrichment data (e.g., lookup information).              |
| **Amazon SNS**        | Publishes final messages to subscribers (email, etc.).          |

## Overview of the Pipe Flow

### 1. SQS Queue (Source)

- The SQS queue will receive messages (for example, from an application or another AWS service).

- This will act as the EventBridge Pipe source.

### 2. EventBridge Pipe

- The Pipe connects the SQS queue (source) to the Lambda function (target).

- It applies filters to only process relevant messages.

- It also supports enrichment, which youâ€™ll perform using the Lambda function.

### 3. Lambda Function (Enricher)

- The Lambda function will be invoked by the Pipe when a filtered message arrives.

- It will fetch additional data from DynamoDB to enrich the message.

- The enriched message will then be published to the SNS topic.

### 4. DynamoDB Table

- Stores data that the Lambda function uses to enrich incoming messages (e.g., user info, product details, etc.).

### 5. SNS Topic (Destination)

- Receives the enriched message from the Lambda function.

- Publishes the message to subscribers, such as an email endpoint.

### 6. Email Subscriber

- Youâ€™ll subscribe an email address to the SNS topic to receive the final, enriched event notifications.

---


## 1. Purpose:

- The Pipe source listens to the SQS queue.

- The Pipe enrichment step invokes a Lambda function to add extra data.

- The Pipe target sends the enriched event to an SNS topic.


## 2. Prerequisites

- Make sure the IAM Role for the Pipe has permissions to:

  - Read from SQS
                
  - Invoke the Lambda function
        
  - Publish to SNS
        
  - Read/write from EventBridge Pipes

### Example minimal IAM policy (attach to the Pipe execution role):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:sqs:REGION:ACCOUNT_ID:MySourceQueue"
    },
    {
      "Action": "lambda:InvokeFunction",
      "Effect": "Allow",
      "Resource": "arn:aws:lambda:REGION:ACCOUNT_ID:function:EnrichLambda"
    },
    {
      "Action": "sns:Publish",
      "Effect": "Allow",
      "Resource": "arn:aws:sns:REGION:ACCOUNT_ID:MyTargetTopic"
    }
  ]
}

```

### 3. Creating the Pipe via AWS Console

1. Open Amazon EventBridge â†’ Pipes â†’ Create pipe

2. Pipe name: SQSLambdaSNSTestPipe

3. Source: Select your SQS queue

4. Filter (optional):

    ```json
    {
      "detail-type": ["order-created"]
    }
    ```

5. Enrichment: Choose Lambda function â†’ EnrichLambda

6. Target: Select SNS topic â†’ MyTargetTopic

7. Permissions:

    - Create or choose an existing IAM role with permissions above.

8. Click Create pipe

Once the Pipe is active, EventBridge automatically reads messages from SQS, invokes your Lambda to enrich them, and sends the output to SNS.

## 4. Creating the Pipe Using AWS CLI

Hereâ€™s how to do the same from the CLI:

```
aws pipes create-pipe \
  --name SQSLambdaSNSTestPipe \
  --source arn:aws:sqs:REGION:ACCOUNT_ID:MySourceQueue \
  --enrichment arn:aws:lambda:REGION:ACCOUNT_ID:function:EnrichLambda \
  --target arn:aws:sns:REGION:ACCOUNT_ID:MyTargetTopic \
  --role-arn arn:aws:iam::ACCOUNT_ID:role/EventBridgePipeRole \
  --source-parameters '{"SqsQueueParameters": {"BatchSize": 1}}' \
  --enrichment-parameters '{"InputTemplate": "{\"message\": <$.body> }"}'
```

ðŸ’¡ You can add filters and advanced enrichment templates using --filter-criteria and --enrichment-parameters.

### Example filter:

```
--filter-criteria '{
  "Filters": [
    {
      "Pattern": "{\"detail-type\": [\"order-created\"]}"
    }
  ]
}'
```

## 5. Testing the Flow

- Send a test message to SQS:

```
aws sqs send-message \
  --queue-url https://sqs.REGION.amazonaws.com/ACCOUNT_ID/MySourceQueue \
  --message-body '{"detail-type": "order-created", "orderId": "12345"}'
```

- Watch the Lambda logs in CloudWatch â€” you should see it invoked by EventBridge Pipe.

- Check the SNS email (if you subscribed via email) â€” you should receive the enriched event.

## 6. Verification Checklist

| Component          | Status | Checkpoint                |
| ------------------ | ------ | ------------------------- |
| SQS Queue          | âœ…      | Message sent              |
| EventBridge Pipe   | âœ…      | Active & connected        |
| Lambda Function    | âœ…      | Invoked for enrichment    |
| DynamoDB (if used) | âœ…      | Queried successfully      |
| SNS Topic          | âœ…      | Message received          |
| Email Subscriber   | âœ…      | Enriched message received |
